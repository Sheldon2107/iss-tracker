<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>ISS Tracker Dashboard</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body { font-family:sans-serif; background:#071026; color:#e6f0fb; margin:0; padding:0; }
#map { height:400px; border-radius:12px; margin:12px; }
#gauges { display:flex; gap:20px; justify-content:center; margin:12px; }
canvas { background:#06203a; border-radius:12px; padding:12px; }
#controls { display:flex; gap:12px; justify-content:center; margin:12px; }
input[type=range] { width:300px; }
</style>
</head>
<body>
<h1 style="text-align:center;">ISS Tracker Dashboard</h1>

<div id="map"></div>

<div id="controls">
    <input type="range" id="timelineSlider" min="0" max="0" value="0">
    <button id="playPauseBtn">Play</button>
</div>

<div id="gauges">
    <canvas id="altitudeGauge" width="150" height="150"></canvas>
    <canvas id="velocityGauge" width="150" height="150"></canvas>
</div>

<script>
const map = L.map('map').setView([0,0],2);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

let marker = L.marker([0,0]).addTo(map);
let polyline = L.polyline([], {color:'cyan'}).addTo(map);

let historicalData = [];
let slider = document.getElementById('timelineSlider');
let playBtn = document.getElementById('playPauseBtn');
let playing = false;
let animationIndex = 0;

async function fetchData() {
    try {
        const resp = await axios.get('/history?limit=1000');
        historicalData = resp.data.data.reverse();
        polyline.setLatLngs(historicalData.map(p => [p.latitude,p.longitude]));
        slider.max = historicalData.length-1;
        updateGauges();
    } catch(e){ console.error(e); }
}

function updateGauges(){
    const last = historicalData[historicalData.length-1];
    if(!last) return;
    altitudeGauge.data.datasets[0].data = [last.altitude, 500-last.altitude];
    altitudeGauge.update();
    velocityGauge.data.datasets[0].data = [last.velocity, 8-last.velocity];
    velocityGauge.update();
}

slider.addEventListener('input', () => {
    animationIndex = parseInt(slider.value);
    const point = historicalData[animationIndex];
    marker.setLatLng([point.latitude, point.longitude]);
    map.setView([point.latitude, point.longitude], map.getZoom());
});

playBtn.addEventListener('click', () => {
    playing = !playing;
    playBtn.textContent = playing ? 'Pause' : 'Play';
});

function animate() {
    if(playing && historicalData.length>0){
        animationIndex = (animationIndex+1) % historicalData.length;
        slider.value = animationIndex;
        const point = historicalData[animationIndex];
        marker.setLatLng([point.latitude, point.longitude]);
        map.setView([point.latitude, point.longitude], map.getZoom());
    }
    requestAnimationFrame(animate);
}

animate();
fetchData();

// Gauges
const altitudeGauge = new Chart(document.getElementById('altitudeGauge'),{
    type:'doughnut',
    data:{labels:['Altitude','Remaining'],datasets:[{data:[0,500],backgroundColor:['#4fc3f7','rgba(255,255,255,0.05)'],borderWidth:0}]},
    options:{cutout:'70%',responsive:false,plugins:{legend:{display:false}}}
});
const velocityGauge = new Chart(document.getElementById('velocityGauge'),{
    type:'doughnut',
    data:{labels:['Velocity','Remaining'],datasets:[{data:[0,8],backgroundColor:['#fbc02d','rgba(255,255,255,0.05)'],borderWidth:0}]},
    options:{cutout:'70%',responsive:false,plugins:{legend:{display:false}}}
});
</script>
</body>
</html>
